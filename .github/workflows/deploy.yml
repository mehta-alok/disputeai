name: Deploy

on:
  push:
    branches: [main, develop]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ECR_REGISTRY }}
  BACKEND_ECR_REPOSITORY: disputeai-backend
  FRONTEND_ECR_REPOSITORY: disputeai-frontend

jobs:
  set-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      ecs_cluster: ${{ steps.set-env.outputs.ecs_cluster }}
      backend_service: ${{ steps.set-env.outputs.backend_service }}
      frontend_service: ${{ steps.set-env.outputs.frontend_service }}
    steps:
      - name: Set deployment environment
        id: set-env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
            echo "ecs_cluster=disputeai-prod" >> "$GITHUB_OUTPUT"
            echo "backend_service=disputeai-backend-prod" >> "$GITHUB_OUTPUT"
            echo "frontend_service=disputeai-frontend-prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=development" >> "$GITHUB_OUTPUT"
            echo "ecs_cluster=disputeai-dev" >> "$GITHUB_OUTPUT"
            echo "backend_service=disputeai-backend-dev" >> "$GITHUB_OUTPUT"
            echo "frontend_service=disputeai-frontend-dev" >> "$GITHUB_OUTPUT"
          fi

  build-and-push-backend:
    name: Build & Push Backend Image
    runs-on: ubuntu-latest
    needs: [set-environment]
    environment: ${{ needs.set-environment.outputs.environment }}
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_ECR_REPOSITORY }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend-deploy
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-and-push-frontend:
    name: Build & Push Frontend Image
    runs-on: ubuntu-latest
    needs: [set-environment]
    environment: ${{ needs.set-environment.outputs.environment }}
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_ECR_REPOSITORY }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend-deploy
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}

  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: [set-environment, build-and-push-backend, build-and-push-frontend]
    environment: ${{ needs.set-environment.outputs.environment }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy backend service to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ needs.set-environment.outputs.ecs_cluster }} \
            --service ${{ needs.set-environment.outputs.backend_service }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy frontend service to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ needs.set-environment.outputs.ecs_cluster }} \
            --service ${{ needs.set-environment.outputs.frontend_service }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for backend service stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ needs.set-environment.outputs.ecs_cluster }} \
            --services ${{ needs.set-environment.outputs.backend_service }} \
            --region ${{ env.AWS_REGION }}

      - name: Wait for frontend service stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ needs.set-environment.outputs.ecs_cluster }} \
            --services ${{ needs.set-environment.outputs.frontend_service }} \
            --region ${{ env.AWS_REGION }}

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Parameter | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Environment | ${{ needs.set-environment.outputs.environment }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Cluster | ${{ needs.set-environment.outputs.ecs_cluster }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backend Service | ${{ needs.set-environment.outputs.backend_service }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Frontend Service | ${{ needs.set-environment.outputs.frontend_service }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Commit | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Triggered by | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
